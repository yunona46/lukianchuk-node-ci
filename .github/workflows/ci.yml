# GitHub Actions CI Pipeline
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –∑–±—ñ—Ä–∫–∞ Node.js –ø—Ä–æ—î–∫—Ç—É ci-node-demo

name: CI Pipeline

# –ö–æ–ª–∏ –∑–∞–ø—É—Å–∫–∞—Ç–∏ —Ü–µ–π workflow
on:
  push:
    branches:
      - main  # –ó–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è –ø—Ä–∏ push –¥–æ –≥—ñ–ª–∫–∏ main
  pull_request:
    branches:
      - main  # –¢–∞–∫–æ–∂ –ø—Ä–∏ pull request –¥–æ main

# –ó–∞–≤–¥–∞–Ω–Ω—è (jobs), —è–∫—ñ –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏–º—É—Ç—å—Å—è
jobs:
  # –ù–∞–∑–≤–∞ –∑–∞–≤–¥–∞–Ω–Ω—è
  build:
    # –ù–∞ —è–∫—ñ–π –æ–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ–π —Å–∏—Å—Ç–µ–º—ñ –∑–∞–ø—É—Å–∫–∞—Ç–∏
    runs-on: ubuntu-latest

    # –ü–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å –∫—Ä–æ–∫—ñ–≤
    steps:
      # –ö—Ä–æ–∫ 1: –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–æ–¥ –∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é
      - name: Checkout repository
        uses: actions/checkout@v4

      # –ö—Ä–æ–∫ 2: –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'  # –í–µ—Ä—Å—ñ—è Node.js

      # –ö—Ä–æ–∫ 3: –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ (—è–∫—â–æ —î)
      - name: Install dependencies
        run: npm install

      # –ö—Ä–æ–∫ 4: –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –±—ñ–ª–¥
      - name: Build project
        run: npm run build

      # –ö—Ä–æ–∫ 5: –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —â–æ –±—ñ–ª–¥ —É—Å–ø—ñ—à–Ω–∏–π
      - name: Verify build output
        run: |
          if [ -d "dist" ]; then
            echo "‚úì Build directory created successfully"
            echo "Contents of dist/:"
            ls -lah dist/
            echo ""
            echo "Content of index.html:"
            cat dist/index.html
          else
            echo "‚úó Build directory not found!"
            exit 1
          fi

      # –ö—Ä–æ–∫ 6: –ó–∞–ø—É—Å—Ç–∏—Ç–∏ index.js –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
      - name: Test index.js
        run: node index.js

      # –ö—Ä–æ–∫ 7: –ó–±–µ—Ä–µ–≥—Ç–∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç (–ø–∞–ø–∫—É dist)
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: dist/
          retention-days: 7  # –ó–±–µ—Ä—ñ–≥–∞—Ç–∏ 7 –¥–Ω—ñ–≤

      # –ö—Ä–æ–∫ 8: –ü–æ–∫–∞–∑–∞—Ç–∏ —É—Å–ø—ñ—à–Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
      - name: CI completed
        run: |
          echo " CI Pipeline completed successfully!"

      #  –ù–û–í–Ü –ö–†–û–ö–ò –î–õ–Ø –î–ï–ü–õ–û–Æ –ù–ê EC2 


      # –ö—Ä–æ–∫: –î–µ–∫–æ–¥—É–≤–∞–Ω–Ω—è SSH –∫–ª—é—á–∞

      - name:  Decode SSH key

        run: |

          echo "${{ secrets.EC2_SSH_KEY_B64 }}" | base64 -d > ec2-key.pem

          chmod 600 ec2-key.pem

       # –ö—Ä–æ–∫: –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è rsync
      - name: üì¶ Install rsync
        run: sudo apt-get update && sudo apt-get install -y rsync

      # –ö—Ä–æ–∫: –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ –Ω–∞ EC2

      - name:  Deploy to EC2

        run: |

          rsync -avz --delete \

            -e "ssh -i ec2-key.pem -o StrictHostKeyChecking=no" \

            --exclude 'node_modules' \

            --exclude '.git' \

            ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USER }}/nodeapp/


      # –ö—Ä–æ–∫: –ó–∞–ø—É—Å–∫ –∑–∞—Å—Ç–æ—Å—É–Ω–∫—É –Ω–∞ EC2

      - name:  Start application on EC2

        run: |

          ssh -i ec2-key.pem -o StrictHostKeyChecking=no \

            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'

          cd /home/ubuntu/nodeapp


          # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ Node.js —è–∫—â–æ –Ω–µ–º–∞—î

          if ! command -v node &> /dev/null; then

            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -

            sudo apt-get install -y nodejs

          fi


          # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ PM2 —è–∫—â–æ –Ω–µ–º–∞—î

          if ! command -v pm2 &> /dev/null; then

            sudo npm install -g pm2

          fi


          # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ

          npm install


          # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—î–º–æ –∑–∞—Å—Ç–æ—Å—É–Ω–æ–∫

          pm2 restart index.js || pm2 start index.js --name nodeapp

          pm2 save


          echo " Application deployed and running!"

          EOF
