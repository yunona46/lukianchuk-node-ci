# GitHub Actions CI Pipeline
# Автоматична збірка Node.js проєкту ci-node-demo

name: CI Pipeline

# Коли запускати цей workflow
on:
  push:
    branches:
      - main  # Запускається при push до гілки main
  pull_request:
    branches:
      - main  # Також при pull request до main

# Завдання (jobs), які виконуватимуться
jobs:
  # Назва завдання
  build:
    # На якій операційній системі запускати
    runs-on: ubuntu-latest

    # Послідовність кроків
    steps:
      # Крок 1: Завантажити код з репозиторію
      - name: Checkout repository
        uses: actions/checkout@v4

      # Крок 2: Встановити Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'  # Версія Node.js

      # Крок 3: Встановити залежності (якщо є)
      - name: Install dependencies
        run: npm install

      # Крок 4: Запустити білд
      - name: Build project
        run: npm run build

      # Крок 5: Перевірити, що білд успішний
      - name: Verify build output
        run: |
          if [ -d "dist" ]; then
            echo "✓ Build directory created successfully"
            echo "Contents of dist/:"
            ls -lah dist/
            echo ""
            echo "Content of index.html:"
            cat dist/index.html
          else
            echo "✗ Build directory not found!"
            exit 1
          fi

      # Крок 6: Запустити index.js для перевірки
      - name: Test index.js
        run: node index.js

      # Крок 7: Зберегти артефакт (папку dist)
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: dist/
          retention-days: 7  # Зберігати 7 днів

      # Крок 8: Показати успішне завершення
      - name: CI completed
        run: |
          echo " CI Pipeline completed successfully!"

      #  НОВІ КРОКИ ДЛЯ ДЕПЛОЮ НА EC2 


      # Крок: Декодування SSH ключа

      - name:  Decode SSH key

        run: |

          echo "${{ secrets.EC2_SSH_KEY_B64 }}" | base64 -d > ec2-key.pem

          chmod 600 ec2-key.pem


      # Крок: Копіювання файлів на EC2

      - name:  Deploy to EC2

        run: |

          rsync -avz --delete \

            -e "ssh -i ec2-key.pem -o StrictHostKeyChecking=no" \

            --exclude 'node_modules' \

            --exclude '.git' \

            ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USER }}/nodeapp/


      # Крок: Запуск застосунку на EC2

      - name:  Start application on EC2

        run: |

          ssh -i ec2-key.pem -o StrictHostKeyChecking=no \

            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'

          cd /home/ubuntu/nodeapp


          # Встановлюємо Node.js якщо немає

          if ! command -v node &> /dev/null; then

            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -

            sudo apt-get install -y nodejs

          fi


          # Встановлюємо PM2 якщо немає

          if ! command -v pm2 &> /dev/null; then

            sudo npm install -g pm2

          fi


          # Встановлюємо залежності

          npm install


          # Перезапускаємо застосунок

          pm2 restart index.js || pm2 start index.js --name nodeapp

          pm2 save


          echo " Application deployed and running!"

          EOF
